/**
 * backend/drive.js
 * FIXED - SUPPORTS BOTH /upload AND /upload/:userId
 */

const express = require("express");
const multer = require("multer");
const path = require("path");
const fs = require("fs");
const db = require("./db");

const router = express.Router();

// ------------------------ BASE UPLOAD DIR ------------------------
const ROOT_UPLOADS = path.join(__dirname, "uploads");
if (!fs.existsSync(ROOT_UPLOADS)) fs.mkdirSync(ROOT_UPLOADS);

// Ensure per-user directory exists
function ensureUserDir(userId) {
    const userPath = path.join(ROOT_UPLOADS, String(userId));
    if (!fs.existsSync(userPath)) fs.mkdirSync(userPath);
    return userPath;
}

// ------------------------ MULTER CONFIG ------------------------
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        const userId = req.params.userId || req.body.user_id;
        if (!userId) return cb(new Error("Missing user_id"));

        const userDir = ensureUserDir(userId);
        cb(null, userDir);
    },
    filename: (req, file, cb) => {
        const unique = Date.now() + "-" + Math.round(Math.random() * 1e6);
        cb(null, `${unique}-${file.originalname}`);
    }
});

const upload = multer({
    storage,
    limits: {
        fileSize: 20 * 1024 * 1024 // 20 MB
    },
    fileFilter: (req, file, cb) => {
        const allowed = [
            "image/png",
            "image/jpeg",
            "application/pdf",
            "text/plain",
            "application/zip"
        ];
        if (!allowed.includes(file.mimetype)) {
            return cb(new Error("INVALID_FILE_TYPE"));
        }
        cb(null, true);
    }
});

// ------------------------ UPLOAD ROUTES ------------------------
// Handler function (shared logic)
const handleUpload = async (req, res) => {
    try {
        if (!req.file)
            return res.status(400).json({ error: "No file uploaded" });

        const userId = req.params.userId || req.body.user_id;
        if (!userId)
            return res.status(400).json({ error: "user_id missing" });

        const filePath = req.file.path;

        await db.query(
            `INSERT INTO drive_files (user_id, filename, filepath, size)
             VALUES (?, ?, ?, ?)`,
            [userId, req.file.filename, filePath, req.file.size]
        );

        return res.json({
            success: true,
            filename: req.file.filename,
            url: `/uploads/${userId}/${req.file.filename}`
        });

    } catch (err) {
        console.error("UPLOAD ERROR:", err);
        return res.status(500).json({ error: "Upload failed" });
    }
};

// Route 1: POST /drive/upload/:userId (userId in URL)
router.post("/drive/upload/:userId", upload.single("file"), handleUpload);

// Route 2: POST /drive/upload (userId in body)
router.post("/drive/upload", upload.single("file"), handleUpload);

// ------------------------ LIST FILES ------------------------
router.get("/drive/files/:userId", async (req, res) => {
    try {
        const userId = req.params.userId;

        const [files] = await db.query(
            `SELECT id, filename, filepath, size, created_at
             FROM drive_files
             WHERE user_id = ?
             ORDER BY created_at DESC`,
            [userId]
        );

        res.json({ files });

    } catch (err) {
        console.error("LIST ERROR:", err);
        res.status(500).json({ error: "Failed to fetch files" });
    }
});

// ------------------------ DELETE FILE ------------------------
router.delete("/drive/delete/:fileId", async (req, res) => {
    try {
        const fileId = req.params.fileId;

        const [[file]] = await db.query(
            "SELECT filepath FROM drive_files WHERE id = ? LIMIT 1",
            [fileId]
        );

        if (!file) return res.status(404).json({ error: "File not found" });

        // Remove from disk
        if (fs.existsSync(file.filepath)) {
            fs.unlinkSync(file.filepath);
        }

        await db.query("DELETE FROM drive_files WHERE id = ?", [fileId]);

        res.json({ success: true });

    } catch (err) {
        console.error("DELETE ERROR:", err);
        res.status(500).json({ error: "Failed to delete file" });
    }
});

// ------------------------ RENAME FILE ------------------------
router.post("/drive/rename", async (req, res) => {
    try {
        const { fileId, newName } = req.body;

        if (!fileId || !newName)
            return res.status(400).json({ error: "Missing values" });

        const [[file]] = await db.query(
            "SELECT filepath, user_id FROM drive_files WHERE id = ? LIMIT 1",
            [fileId]
        );

        if (!file) return res.status(404).json({ error: "File not found" });

        const oldPath = file.filepath;
        const dir = path.dirname(oldPath);
        const newFilename = Date.now() + "-" + newName;
        const newPath = path.join(dir, newFilename);

        fs.renameSync(oldPath, newPath);

        await db.query(
            "UPDATE drive_files SET filename = ?, filepath = ? WHERE id = ?",
            [newFilename, newPath, fileId]
        );

        res.json({ success: true, newFilename });

    } catch (err) {
        console.error("RENAME ERROR:", err);
        res.status(500).json({ error: "Failed to rename" });
    }
});

module.exports = router;
